<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é«”æ…‹åµæ¸¬æ¸¬è©¦é </title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; }
    body { margin: 16px; color: #222; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .row { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start; }
    .col { flex: 1 1 360px; min-width: 320px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.05); }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background:#fafafa; cursor: pointer; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    #video, #preview, #overlayImg { width: 100%; max-height: 360px; object-fit: contain; border-radius: 8px; background:#f7f7f7; }
    .muted { color:#666; font-size:.9rem; }
    .ok { color:#0a7f3f; }
    .err { color:#b00020; }
    .stack { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    label { user-select: none; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>é«”æ…‹åµæ¸¬æ¸¬è©¦é </h1>

  <div class="card" style="margin-bottom:12px;">
    <div class="stack">
      <strong>å¾Œç«¯ APIï¼š</strong>
      <!-- âœ… æ”¹æˆä½ çš„ ngrok / Render ç¶²å€ -->
      <code id="apiBaseLabel" class="muted"></code>
      <button id="ping" class="btn">ğŸ”Œ æ¸¬è©¦é€£ç·š</button>
      <span id="pingResult" class="muted"></span>
    </div>
    <div class="stack" style="margin-top:8px;">
      <strong>åµæ¸¬é …ç›®ï¼š</strong>
      <label><input type="radio" name="task" value="/hunchback" checked> é§èƒŒ</label>
      <label style="margin-left:12px;"><input type="radio" name="task" value="/shoulder"> é«˜ä½è‚©</label>
      <label style="margin-left:20px;"><input type="checkbox" id="showOverlay" checked> å›å‚³ä¸¦é¡¯ç¤ºéª¨æ¶åœ–</label>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2 style="margin-top:0;">å½±åƒä¾†æº</h2>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="stack" style="margin-top:8px;">
          <button id="switchCamera" class="btn">ğŸ” åˆ‡æ›é¡é ­</button>
          <button id="snap" class="btn">ğŸ“¸ æ‹ç…§</button>
          <label class="btn" for="uploadImage">ğŸ“‚ é¸æ“‡åœ–ç‰‡</label>
          <input type="file" id="uploadImage" accept="image/*" capture="environment" style="display:none;">
        </div>
        <img id="preview" alt="é è¦½" />
        <div class="stack" style="margin-top:8px;">
          <button id="submitBtn" class="btn">ğŸš€ ä¸Šå‚³åµæ¸¬</button>
          <button id="resetBtn" class="btn">ğŸ§¹ é‡ç½®</button>
        </div>
        <p class="muted">æç¤ºï¼šå»ºè­°æ­£å´é¢ã€ç­‰é«˜ã€è·é›¢é©ä¸­ï¼Œç©¿è‘—è²¼èº«ä¸Šè¡£æ›´å¥½ã€‚</p>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h2 style="margin-top:0;">åµæ¸¬çµæœ</h2>
        <div id="result" class="muted">å°šæœªåµæ¸¬</div>
        <img id="overlayImg" alt="éª¨æ¶ç–Šåœ–"
     style="display:block; max-width:100%; max-height:360px; margin-top:8px; border:1px solid #ccc; border-radius:8px;" />
      </div>
    </div>
  </div>

  <script>
    // ====== 1) å¾Œç«¯ä½ç½®ï¼šæ”¹æˆä½ ç›®å‰å•Ÿç”¨çš„å¾Œç«¯ï¼ˆæ“‡ä¸€ï¼‰ ======
    // const API_BASE = "http://127.0.0.1:5000";                       // æœ¬æ©Ÿ
    // const API_BASE = "https://<ä½ çš„-ngrok>.ngrok-free.app";          // ngrok
    const API_BASE = "http://127.0.0.1:5000";              // Renderï¼ˆç¤ºä¾‹ï¼‰
    document.getElementById('apiBaseLabel').textContent = API_BASE;

    // ====== 2) DOM åƒç…§ ======
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const snapBtn = document.getElementById('snap');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const switchCameraBtn = document.getElementById('switchCamera');
    const uploadInput = document.getElementById('uploadImage');
    const resultBox = document.getElementById('result');
    const overlayImg = document.getElementById('overlayImg');
    const showOverlay = document.getElementById('showOverlay');
    const pingBtn = document.getElementById('ping');
    const pingResult = document.getElementById('pingResult');

    let currentEndpoint = "/hunchback";
    document.querySelectorAll('input[name="task"]').forEach(r => {
      r.onchange = e => { currentEndpoint = e.target.value; };
    });

    let currentStream = null;
    let useFrontCamera = false;
    let imageBlob = null;

    // ====== 3) æ”å½±æ©Ÿ ======
    async function startCamera() {
      try {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: useFrontCamera ? "user" : "environment" }
        });
        video.srcObject = currentStream;
      } catch (err) {
        console.error(err);
        alert("âŒ æ”å½±æ©ŸéŒ¯èª¤ï¼š" + err.message);
      }
    }
    switchCameraBtn.onclick = () => { useFrontCamera = !useFrontCamera; startCamera(); };
    startCamera();

    // ====== 4) æ‹ç…§ / é¸åœ– ======
    snapBtn.onclick = () => {
      if (!video.videoWidth) { alert("æ”å½±æ©Ÿå°šæœªå°±ç·’"); return; }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      preview.src = canvas.toDataURL('image/png');
      canvas.toBlob(blob => { imageBlob = blob; }, 'image/png');
      resultBox.textContent = "å·²æ‹ç…§ï¼Œæº–å‚™ä¸Šå‚³â€¦";
      resultBox.className = "muted";
      overlayImg.src = "";
    };

    uploadInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { preview.src = ev.target.result; };
      reader.readAsDataURL(file);
      imageBlob = file;
      resultBox.textContent = "å·²é¸æ“‡åœ–ç‰‡ï¼Œæº–å‚™ä¸Šå‚³â€¦";
      resultBox.className = "muted";
      overlayImg.src = "";
    };

    resetBtn.onclick = () => {
      preview.src = "";
      overlayImg.src = "";
      imageBlob = null;
      resultBox.textContent = "å°šæœªåµæ¸¬";
      resultBox.className = "muted";
      startCamera();
    };

    // ====== 5) æ¸¬è©¦é€£ç·š ======
    pingBtn.onclick = async () => {
      pingResult.textContent = "æª¢æŸ¥ä¸­â€¦";
      try {
        const r = await fetch(`${API_BASE}/health`);
        pingResult.textContent = r.ok ? "âœ… å¾Œç«¯é€£ç·šæ­£å¸¸" : `âŒ å¾Œç«¯å›æ‡‰ ${r.status}`;
        pingResult.className = r.ok ? "ok" : "err";
      } catch {
        pingResult.textContent = "âŒ ç„¡æ³•é€£ç·šï¼ˆç¶²è·¯/CORS/ç¶²å€ï¼‰";
        pingResult.className = "err";
      }
    };

    // ====== 6) ä¸Šå‚³åµæ¸¬ ======
    submitBtn.onclick = async () => {
      if (!imageBlob) { alert("è«‹å…ˆæ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡ï¼"); return; }
      submitBtn.disabled = true;
      resultBox.textContent = "åµæ¸¬ä¸­ï¼Œè«‹ç¨å¾Œâ€¦";
      resultBox.className = "muted";
      overlayImg.src = "";

      try {
        const fd = new FormData();
        fd.append('file', imageBlob, 'upload.png');

        const url = `${API_BASE}${currentEndpoint}${showOverlay.checked ? '?overlay=1' : ''}`;
        const res = await fetch(url, { method: 'POST', body: fd });

        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const txt = await res.text();
          throw new Error(`é JSON å›æ‡‰ï¼š${res.status} ${txt.slice(0,200)}`);
        }

        const data = await res.json();
        if (!data.success) {
          resultBox.textContent = `âŒ é æ¸¬å¤±æ•—ï¼š${data.error || "æœªçŸ¥éŒ¯èª¤"}`;
          resultBox.className = "err";
          return;
        }

        const r = data.result;
        const lines = [];
        if (r.side        !== undefined) lines.push(`é¢å‘ï¼š${r.side}`);
        if (r.level       !== undefined) lines.push(`ç­‰ç´šï¼š${r.level}`);
        if (r.score       !== undefined) lines.push(`åˆ†æ•¸ï¼š${r.score}`);

        // é§èƒŒæ¬„ä½
        if (r.hr          !== undefined) lines.push(`é ­å‰å‚¾æ¯”ä¾‹ï¼š${r.hr}`);
        if (r.neck_angle  !== undefined) lines.push(`é ¸éƒ¨è§’åº¦ï¼š${r.neck_angle}Â°`);
        if (r.spine_angle !== undefined) lines.push(`è„Šæ¤è§’åº¦ï¼š${r.spine_angle}Â°`);
        if (r.kyphosis    !== undefined) lines.push(`è„ŠæŸ±å¾Œå‡¸ï¼š${r.kyphosis}Â°`);

        // é«˜ä½è‚©æ¬„ä½
        if (r.higher      !== undefined) lines.push(`è¼ƒé«˜å´ï¼š${r.higher}`);
        if (r.sl_ratio    !== undefined) lines.push(`è‚©è†€é«˜ä½å·®æ¯”ä¾‹ï¼š${r.sl_ratio}`);
        if (r.sl_ratio_rel!== undefined) lines.push(`è‚©/é«–ç›¸å°æ¯”ä¾‹ï¼š${r.sl_ratio_rel}`);
        if (r.sl_angle    !== undefined) lines.push(`è‚©ç·šå‚¾æ–œè§’ï¼š${r.sl_angle}Â°`);

        resultBox.innerHTML = "âœ… åµæ¸¬å®Œæˆï¼š<br>" + lines.join("<br>");
        resultBox.className = "ok";

        // é¡¯ç¤ºéª¨æ¶ç–Šåœ–
        if (showOverlay.checked && r.overlay_base64) {
          overlayImg.src = `data:image/jpeg;base64,${r.overlay_base64}`;
        }

      } catch (err) {
        console.error(err);
        resultBox.textContent = "âŒ è«‹æ±‚å¤±æ•—ï¼š" + err.message;
        resultBox.className = "err";
      } finally {
        submitBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
