<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>體態偵測測試頁</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; }
    body { margin: 16px; color: #222; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .row { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start; }
    .col { flex: 1 1 360px; min-width: 320px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.05); }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background:#fafafa; cursor: pointer; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    #video, #preview, #overlayImg { width: 100%; max-height: 360px; object-fit: contain; border-radius: 8px; background:#f7f7f7; }
    .muted { color:#666; font-size:.9rem; }
    .ok { color:#0a7f3f; }
    .err { color:#b00020; }
    .stack { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    label { user-select: none; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>體態偵測測試頁</h1>

  <div class="card" style="margin-bottom:12px;">
    <div class="stack">
      <strong>後端 API：</strong>
      <!-- ✅ 改成你的 ngrok / Render 網址 -->
      <code id="apiBaseLabel" class="muted"></code>
      <button id="ping" class="btn">🔌 測試連線</button>
      <span id="pingResult" class="muted"></span>
    </div>
    <div class="stack" style="margin-top:8px;">
      <strong>偵測項目：</strong>
      <label><input type="radio" name="task" value="/hunchback" checked> 駝背</label>
      <label style="margin-left:12px;"><input type="radio" name="task" value="/shoulder"> 高低肩</label>
      <label style="margin-left:20px;"><input type="checkbox" id="showOverlay" checked> 回傳並顯示骨架圖</label>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2 style="margin-top:0;">影像來源</h2>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="stack" style="margin-top:8px;">
          <button id="switchCamera" class="btn">🔁 切換鏡頭</button>
          <button id="snap" class="btn">📸 拍照</button>
          <label class="btn" for="uploadImage">📂 選擇圖片</label>
          <input type="file" id="uploadImage" accept="image/*" capture="environment" style="display:none;">
        </div>
        <img id="preview" alt="預覽" />
        <div class="stack" style="margin-top:8px;">
          <button id="submitBtn" class="btn">🚀 上傳偵測</button>
          <button id="resetBtn" class="btn">🧹 重置</button>
        </div>
        <p class="muted">提示：建議正側面、等高、距離適中，穿著貼身上衣更好。</p>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h2 style="margin-top:0;">偵測結果</h2>
        <div id="result" class="muted">尚未偵測</div>
        <img id="overlayImg" alt="骨架疊圖"
     style="display:block; max-width:100%; max-height:360px; margin-top:8px; border:1px solid #ccc; border-radius:8px;" />
      </div>
    </div>
  </div>

  <script>
    // ====== 1) 後端位置：改成你目前啟用的後端（擇一） ======
    // const API_BASE = "http://127.0.0.1:5000";                       // 本機
    // const API_BASE = "https://<你的-ngrok>.ngrok-free.app";          // ngrok
    const API_BASE = "http://127.0.0.1:5000";              // Render（示例）
    document.getElementById('apiBaseLabel').textContent = API_BASE;

    // ====== 2) DOM 參照 ======
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const snapBtn = document.getElementById('snap');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const switchCameraBtn = document.getElementById('switchCamera');
    const uploadInput = document.getElementById('uploadImage');
    const resultBox = document.getElementById('result');
    const overlayImg = document.getElementById('overlayImg');
    const showOverlay = document.getElementById('showOverlay');
    const pingBtn = document.getElementById('ping');
    const pingResult = document.getElementById('pingResult');

    let currentEndpoint = "/hunchback";
    document.querySelectorAll('input[name="task"]').forEach(r => {
      r.onchange = e => { currentEndpoint = e.target.value; };
    });

    let currentStream = null;
    let useFrontCamera = false;
    let imageBlob = null;

    // ====== 3) 攝影機 ======
    async function startCamera() {
      try {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: useFrontCamera ? "user" : "environment" }
        });
        video.srcObject = currentStream;
      } catch (err) {
        console.error(err);
        alert("❌ 攝影機錯誤：" + err.message);
      }
    }
    switchCameraBtn.onclick = () => { useFrontCamera = !useFrontCamera; startCamera(); };
    startCamera();

    // ====== 4) 拍照 / 選圖 ======
    snapBtn.onclick = () => {
      if (!video.videoWidth) { alert("攝影機尚未就緒"); return; }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      preview.src = canvas.toDataURL('image/png');
      canvas.toBlob(blob => { imageBlob = blob; }, 'image/png');
      resultBox.textContent = "已拍照，準備上傳…";
      resultBox.className = "muted";
      overlayImg.src = "";
    };

    uploadInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { preview.src = ev.target.result; };
      reader.readAsDataURL(file);
      imageBlob = file;
      resultBox.textContent = "已選擇圖片，準備上傳…";
      resultBox.className = "muted";
      overlayImg.src = "";
    };

    resetBtn.onclick = () => {
      preview.src = "";
      overlayImg.src = "";
      imageBlob = null;
      resultBox.textContent = "尚未偵測";
      resultBox.className = "muted";
      startCamera();
    };

    // ====== 5) 測試連線 ======
    pingBtn.onclick = async () => {
      pingResult.textContent = "檢查中…";
      try {
        const r = await fetch(`${API_BASE}/health`);
        pingResult.textContent = r.ok ? "✅ 後端連線正常" : `❌ 後端回應 ${r.status}`;
        pingResult.className = r.ok ? "ok" : "err";
      } catch {
        pingResult.textContent = "❌ 無法連線（網路/CORS/網址）";
        pingResult.className = "err";
      }
    };

    // ====== 6) 上傳偵測 ======
    submitBtn.onclick = async () => {
      if (!imageBlob) { alert("請先拍照或選擇圖片！"); return; }
      submitBtn.disabled = true;
      resultBox.textContent = "偵測中，請稍後…";
      resultBox.className = "muted";
      overlayImg.src = "";

      try {
        const fd = new FormData();
        fd.append('file', imageBlob, 'upload.png');

        const url = `${API_BASE}${currentEndpoint}${showOverlay.checked ? '?overlay=1' : ''}`;
        const res = await fetch(url, { method: 'POST', body: fd });

        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const txt = await res.text();
          throw new Error(`非 JSON 回應：${res.status} ${txt.slice(0,200)}`);
        }

        const data = await res.json();
        if (!data.success) {
          resultBox.textContent = `❌ 預測失敗：${data.error || "未知錯誤"}`;
          resultBox.className = "err";
          return;
        }

        const r = data.result;
        const lines = [];
        if (r.side        !== undefined) lines.push(`面向：${r.side}`);
        if (r.level       !== undefined) lines.push(`等級：${r.level}`);
        if (r.score       !== undefined) lines.push(`分數：${r.score}`);

        // 駝背欄位
        if (r.hr          !== undefined) lines.push(`頭前傾比例：${r.hr}`);
        if (r.neck_angle  !== undefined) lines.push(`頸部角度：${r.neck_angle}°`);
        if (r.spine_angle !== undefined) lines.push(`脊椎角度：${r.spine_angle}°`);
        if (r.kyphosis    !== undefined) lines.push(`脊柱後凸：${r.kyphosis}°`);

        // 高低肩欄位
        if (r.higher      !== undefined) lines.push(`較高側：${r.higher}`);
        if (r.sl_ratio    !== undefined) lines.push(`肩膀高低差比例：${r.sl_ratio}`);
        if (r.sl_ratio_rel!== undefined) lines.push(`肩/髖相對比例：${r.sl_ratio_rel}`);
        if (r.sl_angle    !== undefined) lines.push(`肩線傾斜角：${r.sl_angle}°`);

        resultBox.innerHTML = "✅ 偵測完成：<br>" + lines.join("<br>");
        resultBox.className = "ok";

        // 顯示骨架疊圖
        if (showOverlay.checked && r.overlay_base64) {
          overlayImg.src = `data:image/jpeg;base64,${r.overlay_base64}`;
        }

      } catch (err) {
        console.error(err);
        resultBox.textContent = "❌ 請求失敗：" + err.message;
        resultBox.className = "err";
      } finally {
        submitBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
