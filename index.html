<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>體態偵測工具</title>
  <!-- 可選：Google Font（缺網也不影響功能） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== 基礎變數（配色、陰影、圓角） ===== */
    :root{
      --bg-grad-1:#eef3ff;
      --bg-grad-2:#f7fbff;
      --card-bg:#ffffffcc;
      --text:#1a1a1a;
      --muted:#6b7280;
      --primary:#2563eb;        /* 藍 */
      --primary-hover:#1d4ed8;
      --accent:#10b981;         /* 綠 */
      --accent-hover:#0ea371;
      --surface:#ffffff;
      --radius:14px;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --shadow-lg:0 16px 45px rgba(2,6,23,.12);
      --ring:0 0 0 3px rgba(37,99,235,.15);
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color:var(--text);
      /* 柔和漸層背景 */
      background: radial-gradient(1200px 800px at 20% -10%, #e7f0ff 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #f0fff9 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2));
      padding: 32px 20px 40px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    /* 置中卡片容器（不影響原有結構） */
    body > *{
      width:100%;
      max-width: 760px;
      margin-left:auto;
      margin-right:auto;
    }

    h2{
      color:#0f172a;
      font-size: clamp(1.4rem, 1.1rem + 1.2vw, 1.9rem);
      font-weight: 700;
      letter-spacing: .3px;
      margin: 10px auto 14px;
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.4rem .9rem;
      border-radius: 999px;
      background: linear-gradient(180deg, #ffffff, #f6f8ff);
      box-shadow: var(--shadow);
    }

    p{
      color:var(--muted);
      margin:0 auto 10px;
      font-size:.92rem;
    }

    /* 視覺卡片：video / img / canvas */
    video, canvas, img{
      width:100%;
      max-width:100%;
      height:auto;
      margin-top:12px;
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.06);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    }
    video:hover, img:hover{
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(15,23,42,.09);
    }

    /* 按鈕統一樣式 */
    button, input[type="file"]{
      margin: 10px auto;
      padding: 12px 18px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.06);
      background: linear-gradient(180deg, #ffffff, #f6f7fb);
      color: #0f172a;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .12s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(15,23,42,.12);
    }
    button:active{ transform: translateY(0); box-shadow: var(--shadow); }
    button:focus-visible{ outline: none; box-shadow: var(--shadow-lg), var(--ring); }

    /* 主要功能鍵配色覆寫（依原有 ID） */
    #switchCamera{
      background: linear-gradient(180deg, #e8f0ff, #dfe9ff);
      color:#0b2a7a;
    }
    #submitBtn{
      background: linear-gradient(180deg, var(--primary), #1d5fe4);
      color:#fff;
      border-color: transparent;
    }
    #submitBtn:hover{ background: linear-gradient(180deg, var(--primary-hover), #1b55cf); }
    #submitBtn:disabled{
      opacity:.75;
      cursor:not-allowed;
      filter: saturate(.7);
    }

    /* 你原本的 action-button（維持寬度與排版、但更漂亮） */
    .action-button{
      flex: 1 1 45%;
      min-width: 150px;
      max-width: 220px;
      height: 48px;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.06);
      background: linear-gradient(180deg, var(--accent), #0fb07e);
      color: #fff;
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow);
      transition: transform .14s ease, box-shadow .18s ease, filter .18s ease;
    }
    .action-button:hover{ transform: translateY(-1px); box-shadow: var(--shadow-lg); filter: brightness(1.02); }

    /* 結果與連線資訊 */
    #result, #connectionResult{
      margin-top: 16px;
      font-weight: 600;
      color:#0f172a;
    }

    /* 結果卡片（沿用你原本表格，僅調色） */
    .result-card{
      margin-top: 18px;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.06);
      overflow:hidden;
      text-align:left;
    }
    .result-title{
      padding: 12px 16px;
      font-weight: 700;
      color:#0f172a;
      background: linear-gradient(180deg, #fbfbff, #f5f7ff);
      border-bottom: 1px solid rgba(15,23,42,.06);
    }
    .result-table{
      width:100%;
      border-collapse: collapse;
      font-size: .96rem;
    }
    .result-table th,
    .result-table td{
      padding: 11px 16px;
      border-bottom: 1px solid #f1f3f7;
      vertical-align: top;
    }
    .result-table th{
      width: 42%;
      background: #fbfcff;
      color:#334155;
      font-weight: 600;
    }
    .result-table tr:last-child td,
    .result-table tr:last-child th{ border-bottom: none; }

    /* 小尺寸優化 */
    @media (max-width: 420px){
      .result-table th, .result-table td{ padding: 10px 12px; }
    }

    /* 版心寬度控制（保留你的 700px 行為，但視覺更一致） */
    @media (min-width: 768px){
      body{ padding-top: 40px; }
      body > *{ max-width: 720px; }
    }

    /* 深色模式加分（跟隨系統，不動功能） */
    @media (prefers-color-scheme: dark){
      :root{
        --bg-grad-1:#101827;
        --bg-grad-2:#0b1220;
        --surface:#0f172a;
        --text:#e5e7eb;
        --muted:#9aa3b2;
        --card-bg:#101828e6;
      }
      body{
        background:
          radial-gradient(800px 600px at 15% -10%, rgba(59,130,246,.2) 0%, transparent 60%),
          radial-gradient(800px 600px at 100% 0%, rgba(16,185,129,.15) 0%, transparent 60%),
          linear-gradient(180deg, #0b1220, #0b1220 60%, #0a101a);
      }
      h2{ background: linear-gradient(180deg, #0f172a, #111b2e); color:#e8eefc; }
      p{ color:#9aa3b2; }
      video, canvas, img{
        background:#0b1020;
        border-color: rgba(255,255,255,.06);
      }
      button, input[type="file"]{
        background: linear-gradient(180deg, #141c2c, #0f172a);
        color:#e5e7eb;
        border-color: rgba(255,255,255,.06);
      }
      .action-button{
        background: linear-gradient(180deg, #10b981, #0b9467);
        border-color: rgba(255,255,255,.06);
      }
      .result-card{
        background: #0f172a;
        border-color: rgba(255,255,255,.06);
      }
      .result-title{
        background: linear-gradient(180deg, #121b2e, #0f172a);
        border-bottom-color: rgba(255,255,255,.06);
        color:#e5edff;
      }
      .result-table th{ background:#0e1626; color:#cbd5e1; }
      .result-table td{ color:#e5e7eb; }
      #result, #connectionResult{ color:#e5e7eb; }
    }
  </style>
</head>
<body>

  <p style="font-size: 0.9rem; color: #666; margin-bottom: 6px; text-align: center;">
    本網頁為【AI輔助健康姿勢偵測與矯正系統】偵測功能介面<br>
  </p>

  <h2>駝背偵測工具</h2>

  <button id="switchCamera">🔄 切換鏡頭</button><br>
  <video id="video" autoplay playsinline></video><br>

  <!-- 保持你原本的排列（不動 inline style 與 DOM） -->
  <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 16px; flex-wrap: wrap;">
    <button id="snap" class="action-button">拍照</button>
    <label for="uploadImage" class="action-button">選擇圖片</label>
  </div>

  <input type="file" id="uploadImage" accept="image/*" style="display:none;">

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" alt="圖片預覽" /><br>

  <button id="submitBtn">🚀 上傳圖片</button>

  <div id="result"></div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('preview');
  const snapBtn = document.getElementById('snap');
  const submitBtn = document.getElementById('submitBtn');
  const switchCameraBtn = document.getElementById('switchCamera');
  const uploadInput = document.getElementById('uploadImage');
  const resultBox = document.getElementById('result');
  const poseBtn = document.getElementById('poseBtn');

  // const API_BASE = "http://127.0.0.1:5000";
  // const API_BASE = "https://<你的-ngrok>.ngrok-free.app";
  const API_BASE = "https://mammary-overwidely-braylen.ngrok-free.dev";
  let currentEndpoint = "/hunchback";

  let currentStream = null;
  let useFrontCamera = false;
  let imageBlob = null;

  function resetPage() {
    preview.src = "";
    resultBox.innerHTML = "";
    imageBlob = null;
    startCamera();
  }

  async function startCamera() {
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: useFrontCamera ? "user" : "environment" }
      });
      video.srcObject = currentStream;
    } catch (err) { alert("❌ 攝影機錯誤：" + err.message); }
  }

  switchCameraBtn.onclick = () => { useFrontCamera = !useFrontCamera; startCamera(); };
  startCamera();

  snapBtn.onclick = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    preview.src = canvas.toDataURL('image/png');
    canvas.toBlob(blob => {
      imageBlob = blob;
      submitBtn.scrollIntoView({ behavior: 'smooth' });
    }, 'image/png');
  };

  uploadInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      preview.src = ev.target.result;
      preview.onload = () => setTimeout(() => submitBtn.scrollIntoView({ behavior: 'smooth' }), 100);
    };
    reader.readAsDataURL(file);
    imageBlob = file;
  };

  function renderResultTable(r) {
    const fmt = (v, opt = {}) => {
      if (v === undefined || v === null) return '—';
      if (typeof v === 'number') {
        const n = (opt.dp ?? 2);
        return v.toFixed(n) + (opt.suffix || '');
      }
      return String(v);
    };

    const rows = [];
    if (r.side !== undefined)         rows.push(['面向', r.side]);
    if (r.level !== undefined)        rows.push(['等級', r.level]);
    if (r.hr !== undefined)           rows.push(['頭前傾比例', fmt(r.hr, { dp: 3 })]);
    if (r.neck_angle !== undefined)   rows.push(['頸部角度', fmt(r.neck_angle, { dp: 1, suffix: '°' })]);
    if (r.kyphosis !== undefined)     rows.push(['脊柱後凸', fmt(r.kyphosis, { dp: 1, suffix: '°' })]);
    if (r.higher !== undefined)       rows.push(['較高側', r.higher]);
    if (r.sl_ratio !== undefined)     rows.push(['肩膀高低差比例', fmt(r.sl_ratio, { dp: 3 })]);
    if (r.sl_ratio_rel !== undefined) rows.push(['肩/髖相對比例', fmt(r.sl_ratio_rel, { dp: 3 })]);
    if (r.sl_angle !== undefined)     rows.push(['肩線傾斜角', fmt(r.sl_angle, { dp: 1, suffix: '°' })]);

    for (const k of Object.keys(r)) {
      if (['side','level','score','hr','neck_angle','spine_angle','kyphosis','higher','sl_ratio','sl_ratio_rel','sl_angle'].includes(k)) continue;
      rows.push([k, r[k]]);
    }

    const tableHTML = `
      <div class="result-card">
        <div class="result-title">偵測結果</div>
        <table class="result-table">
          <tbody>
            ${rows.map(([k, v]) => `
              <tr>
                <th>${k}</th>
                <td>${v}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    resultBox.innerHTML = tableHTML;
  }

  submitBtn.onclick = async () => {
    if (!imageBlob) { alert("請先拍照或選擇圖片！"); return; }
    resultBox.innerHTML = "偵測中，請稍後...";
    submitBtn.disabled = true;

    try {
      const fd1 = new FormData();
      fd1.append('file', imageBlob, 'upload.png');

      const resJson = await fetch(`${API_BASE}${currentEndpoint}`, {
        method: 'POST',
        body: fd1
      });

      const ct = resJson.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const txt = await resJson.text();
        throw new Error(`非 JSON 回應：${resJson.status} ${txt.slice(0,200)}`);
      }

      const data = await resJson.json();
      if (!data.success) {
        const msg = "❌ 預測失敗：" + (data.error || "未知錯誤");
        resultBox.innerHTML = msg;
        alert(msg);
        submitBtn.disabled = false;
        return;
      }

      const r = data.result;
      renderResultTable(r);
      alert(`✅ 偵測完成：${r.level || '—'}`);

      const fd2 = new FormData();
      fd2.append('file', imageBlob, 'upload.jpg');

      const resImg = await fetch(`${API_BASE}/pose_img?mode=plain`, {
        method: 'POST',
        body: fd2
      });
      if (!resImg.ok) throw new Error(`骨架圖 HTTP ${resImg.status}`);

      const blob = await resImg.blob();
      if (preview.src) URL.revokeObjectURL(preview.src);
      preview.src = URL.createObjectURL(blob);

    } catch (err) {
      const msg = "❌ 請求失敗：" + err.message;
      resultBox.innerHTML = msg;
      alert(msg);
    } finally {
      submitBtn.disabled = false;
    }
  };
</script>

</body>
</html>
