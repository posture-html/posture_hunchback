<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é«”æ…‹åµæ¸¬å·¥å…·</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f4f4f4;
      text-align: center;
    }
    h2 { color: #333; }
    video, canvas, img {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    button, input[type="file"] {
      margin: 10px auto;
      padding: 12px 18px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    #submitBtn { background-color: #2196F3; }
    #submitBtn:hover { background-color: #1976D2; }
    #result { margin-top: 20px; font-weight: bold; color: #333; }

    .action-button {
      flex: 1 1 45%;
      min-width: 140px;
      max-width: 180px;
      height: 48px;
      background-color: #4CAF50;
      color: white;
      padding: 12px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      text-decoration: none;
    }
    .action-button:hover { background-color: #45a049; }

    @media screen and (min-width: 768px) {
      body { max-width: 700px; margin: auto; }
    }
  </style>
</head>
<body>
  <p style="font-size: 0.85rem; color: #666; margin-bottom: 6px; text-align: center;">
    æœ¬ç¶²é ç‚ºã€AIè¼”åŠ©å¥åº·å§¿å‹¢åµæ¸¬èˆ‡çŸ¯æ­£ç³»çµ±ã€‘åµæ¸¬åŠŸèƒ½ä»‹é¢<br>
    ä»¥è¨“ç·´æ¨¡å‹åˆ†æç…§ç‰‡é€²è¡Œé«”æ…‹åµæ¸¬
  </p>

  <h2>ğŸ“· é§èƒŒåµæ¸¬å·¥å…·</h2>

  <!-- æ”¹ç‚ºã€ŒæŒ‰éˆ•è§¸ç™¼ã€è€Œéè‡ªå‹•å–ç”¨ç›¸æ©Ÿ -->
  <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:8px;">
    <button id="startCamera" class="action-button">ğŸ¥ é–‹å•Ÿç›¸æ©Ÿ</button>
    <button id="switchCamera" class="action-button" disabled>ğŸ”„ åˆ‡æ›é¡é ­</button>
  </div>

  <video id="video" autoplay playsinline muted></video>

  <!-- æ‹ç…§èˆ‡é¸åœ–æŒ‰éˆ• -->
  <div style="display:flex; justify-content:center; align-items:center; gap:12px; margin-top:16px; flex-wrap:wrap;">
    <button id="snap" class="action-button" disabled>ğŸ“¸ æ‹ç…§</button>

    <!-- é€™é¡†æ¨™ç±¤æœƒè§¸ç™¼ä¸‹é¢éš±è—çš„ input -->
    <label for="uploadImage" class="action-button">ğŸ“ é¸æ“‡åœ–ç‰‡</label>
  </div>

  <!-- éš±è— inputï¼šåŠ ä¸Š accept + capture -->
  <input
    type="file"
    id="uploadImage"
    accept="image/*"
    capture="environment"
    style="display:none;"
  >

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" alt="åœ–ç‰‡é è¦½" />
  <br>

  <button id="submitBtn">ğŸš€ ä¸Šå‚³åœ–ç‰‡</button>
  <div id="result"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startCamera');
    const switchCameraBtn = document.getElementById('switchCamera');
    const snapBtn = document.getElementById('snap');
    const uploadInput = document.getElementById('uploadImage');
    const submitBtn = document.getElementById('submitBtn');
    const resultBox = document.getElementById('result');

    let currentStream = null;
    let useFrontCamera = false;
    let imageBlob = null;

    function resetPage() {
      preview.src = "";
      resultBox.innerHTML = "";
      imageBlob = null;
      // åœæ‰ç›¸æ©Ÿ
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      snapBtn.disabled = true;
      switchCameraBtn.disabled = true;
      startBtn.disabled = false;
    }

    async function startCamera() {
      try {
        // æ¯æ¬¡é‡å•Ÿå‰å…ˆåœæ‰èˆŠä¸²æµ
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());

        const constraints = {
          video: { facingMode: useFrontCamera ? 'user' : 'environment' },
          audio: false
        };
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;

        snapBtn.disabled = false;
        switchCameraBtn.disabled = false;
        startBtn.disabled = true;
      } catch (err) {
        alert("âŒ æ”å½±æ©ŸéŒ¯èª¤ï¼š" + err.message);
      }
    }

    // âœ… ä½¿ç”¨è€…æ‰‹å‹¢å¾Œæ‰å–ç”¨ç›¸æ©Ÿï¼ˆæ›´ç›¸å®¹ï¼‰
    startBtn.addEventListener('click', startCamera);

    switchCameraBtn.addEventListener('click', async () => {
      useFrontCamera = !useFrontCamera;
      await startCamera();
    });

    // æ‹ç…§
    snapBtn.addEventListener('click', () => {
      if (!currentStream) {
        alert('è«‹å…ˆé»ã€Œé–‹å•Ÿç›¸æ©Ÿã€');
        return;
      }
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      canvas.getContext('2d').drawImage(video, 0, 0);
      preview.src = canvas.toDataURL('image/png');
      canvas.toBlob(blob => {
        imageBlob = blob;
        submitBtn.scrollIntoView({ behavior: 'smooth' });
      }, 'image/png');
    });

    // ç›¸ç°¿é¸åœ–
    uploadInput.addEventListener('change', e => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        preview.onload = () => {
          setTimeout(() => submitBtn.scrollIntoView({ behavior: 'smooth' }), 100);
        };
      };
      reader.readAsDataURL(file);
      imageBlob = file;
    });

    // ä¸Šå‚³åœ–ç‰‡
    const labelMap = { normal: "æ­£å¸¸", hunchback: "é§èƒŒ" };

    submitBtn.addEventListener('click', () => {
      if (!imageBlob) {
        alert("è«‹å…ˆæ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡ï¼");
        return;
      }
      const formData = new FormData();
      formData.append('file', imageBlob, 'upload.png');

      resultBox.innerHTML = "åµæ¸¬ä¸­ï¼Œè«‹ç¨å¾Œ...";

      fetch('https://pose-app-964k.onrender.com/predict/hunchback', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const label = labelMap[data.result] || data.result;
          let msg = `âœ… é æ¸¬çµæœï¼š${label}<br><br>`;
          if (data.result === "normal") {
            msg += `ğŸ‰ æ‚¨çš„é«”æ…‹åˆ¤æ–·ç‚ºæ­£å¸¸ï¼Œç›®å‰ç„¡éœ€ç‰¹åˆ¥è¨“ç·´è¨ˆç•«ã€‚<br><br>ğŸ“± è‹¥ä»å¸Œæœ›æ”¹å–„ç·´ç¿’ï¼Œå¯å› App è¼¸å…¥ã€Œé§èƒŒã€å–å¾—è¨ˆç•«ã€‚`;
            alert(`âœ… é æ¸¬çµæœï¼šæ­£å¸¸\n\nğŸ‰ æ‚¨çš„é«”æ…‹åˆ¤æ–·ç‚ºæ­£å¸¸ï¼Œç›®å‰ç„¡éœ€ç‰¹åˆ¥è¨“ç·´è¨ˆç•«ã€‚\nğŸ“± è‹¥ä»å¸Œæœ›æ”¹å–„ç·´ç¿’ï¼Œå¯å› App è¼¸å…¥ã€Œé§èƒŒã€å–å¾—è¨ˆç•«`);
          } else {
            msg += `ğŸ“± è«‹é»é¸æ‰‹æ©Ÿã€Œè¿”å›éµã€å›åˆ° App è¼¸å…¥åµæ¸¬çµæœ`;
            alert(`âœ… é æ¸¬çµæœï¼šé§èƒŒ\n\nğŸ“± è«‹é»é¸æ‰‹æ©Ÿã€Œè¿”å›éµã€å›åˆ° App è¼¸å…¥åµæ¸¬çµæœ`);
          }
          resultBox.innerHTML = msg;
          setTimeout(resetPage, 10000);
        } else if (data.error) {
          const err = "âŒ é æ¸¬éŒ¯èª¤ï¼š" + data.error;
          resultBox.innerHTML = err;
          alert(err);
        } else {
          const unknown = "âš ï¸ æœªçŸ¥éŒ¯èª¤ï¼š" + JSON.stringify(data);
          resultBox.innerHTML = unknown;
          alert(unknown);
        }
      })
      .catch(err => {
        const msg = "âŒ è«‹æ±‚å¤±æ•—ï¼š" + err.message;
        resultBox.innerHTML = msg;
        alert(msg);
      });
    });
  </script>
</body>
</html>
